services:
  postgres:
    image: postgres:15.5-alpine
    container_name: ardha-postgres
    environment:
      POSTGRES_DB: ardha_dev
      POSTGRES_USER: ardha_user
      POSTGRES_PASSWORD: ardha_password
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    mem_limit: 2g
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ardha_user -d ardha_dev"]
      interval: 30s
      timeout: 10s
      retries: 3

  qdrant:
    image: qdrant/qdrant:v1.7.4
    container_name: ardha-qdrant
    ports:
      - "6333:6333"
    volumes:
      - qdrant_data:/qdrant/storage
    mem_limit: 2560m
    restart: unless-stopped
    environment:
      QDRANT__SERVICE__HTTP_PORT: 6333
      QDRANT__SERVICE__GRPC_PORT: 6334
      QDRANT__STORAGE__PERFORMANCE__MAX_SEARCH_THREADS: 4
      QDRANT__STORAGE__PERFORMANCE__MAX_OPTIMIZATION_THREADS: 2

  redis:
    image: redis:7.2-alpine
    container_name: ardha-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    mem_limit: 512m
    restart: unless-stopped
    command: redis-server --maxmemory 400mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: ardha-backend
    ports:
      - "8000:8000"
    volumes:
      - ./backend:/app
      - ./backend/.venv:/app/.venv
    mem_limit: 2g
    restart: unless-stopped
    env_file:
      - ./backend/.env
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      qdrant:
        condition: service_started
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  celery-worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: ardha-celery-worker
    command: celery -A ardha.core.celery_app worker --loglevel=info --concurrency=2
    volumes:
      - ./backend:/app
      - ./backend/.cache:/app/.cache  # For sentence-transformers model cache
    mem_limit: 2g
    restart: unless-stopped
    env_file:
      - ./backend/.env
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      qdrant:
        condition: service_started

  celery-beat:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: ardha-celery-beat
    command: celery -A ardha.core.celery_app beat --loglevel=info
    volumes:
      - ./backend:/app
    mem_limit: 512m
    restart: unless-stopped
    env_file:
      - ./backend/.env
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      celery-worker:
        condition: service_started

  flower:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: ardha-flower
    command: celery -A ardha.core.celery_app flower --port=5555
    ports:
      - "5555:5555"
    volumes:
      - ./backend:/app
    mem_limit: 256m
    restart: unless-stopped
    env_file:
      - ./backend/.env
    depends_on:
      redis:
        condition: service_healthy
      celery-worker:
        condition: service_started

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: ardha-frontend
    ports:
      - "3000:3000"
    volumes:
      - ./frontend:/app
      - ./frontend/node_modules:/app/node_modules
    mem_limit: 1g
    restart: unless-stopped
    environment:
      - NODE_ENV=development
    depends_on:
      - backend
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  postgres_data:
    driver: local
  qdrant_data:
    driver: local
  redis_data:
    driver: local
